pipeline{
    agent any
    environment{
        AWS_DEFAULT_REGION='us-east-1'
        AWS_CREDENTIALS=credentials('aws-credentials')
        DOCKER_IMAGE_NAME='jairotunior/django-app:latest'
    }
    stages {
        stage('SV Project'){
            steps{
                sh 'trivy fs --security-checks vuln,secret,config --severity HIGH,CRITICAL,MEDIUM --no-progress --exit-code 1 .'
            }
        }
        stage('Build'){
            steps{
                sh "docker build -t ${DOCKER_IMAGE_NAME} ."
            }
        }
        stage('SV Docker Build'){
            steps{
                sh "trivy image --no-progress --exit-code 1 --severity MEDIUM,HIGH,CRITICAL ${DOCKER_IMAGE_NAME}"
            }
        }
    }
}